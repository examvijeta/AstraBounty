import subprocess
import os

class VulnerabilityModule:
    """Automated Vulnerability Scanning using Nuclei and Dalfox."""

    def __init__(self, target, output_dir):
        self.target = target
        self.output_dir = output_dir
        self.nuclei_file = os.path.join(output_dir, "nuclei_findings.txt")
        self.xss_file = os.path.join(output_dir, "xss_findings.txt")

    def run_nuclei(self, input_file, h1_user=None, email=None):
        """Runs Nuclei on discovered hosts and endpoints."""
        print(f"[*] Starting Nuclei Autonomous Scan for {self.target}...")
        if not os.path.exists(input_file):
            print("[!] Input file not found for Nuclei.")
            return None

        try:
            # -sv: scan only critical/high/medium, -silent, -o output
            command = [
                "nuclei", 
                "-l", input_file, 
                "-silent", 
                "-severity", "critical,high,medium",
                "-o", self.nuclei_file
            ]
            
            # Compliance headers
            if h1_user: command.extend(["-H", f"X-Bug-Bounty: {h1_user}"])
            if email: command.extend(["-H", f"X-Test-Account-Email: {email}"])

            subprocess.run(command)
            if os.path.exists(self.nuclei_file):
                print(f"[+] Nuclei scan complete. Findings: {self.nuclei_file}")
                return self.nuclei_file
        except Exception as e:
            print(f"[!] Nuclei error: {e}")
        return None

    def run_dalfox(self, endpoints_file):
        """Runs Dalfox for automated XSS discovery on all endpoints."""
        print(f"[*] Starting Dalfox XSS Probing on all discovered endpoints...")
        if not os.path.exists(endpoints_file):
            return None

        try:
            # -silent, --silence: quiet mode, -o: output
            command = [
                "dalfox", "file", endpoints_file, 
                "--silent", 
                "--output", self.xss_file
            ]
            subprocess.run(command)
            if os.path.exists(self.xss_file):
                print(f"[+] Dalfox scan complete. Potential XSS found: {self.xss_file}")
                return self.xss_file
        except Exception as e:
            print(f"[!] Dalfox error: {e}")
        return None
